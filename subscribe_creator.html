<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
  <title>YAWF 订阅创建器</title>
  <meta name="keywords" content="Weibo, Sina Weibo, 微博, 新浪微博, 过滤, Filter, YAWF, Yet Another Weibo Filter, 看真正想看的微博" />
  <meta name="description" content="根据 Yet Another Weibo Filter 脚本的设置创建扩展脚本以方便共享给他人使用。" />
  <link rel="canonical" href="https://tiansh.github.io/yawf/subscribe_creator.html">
  <link rel="stylesheet" href="main.css" />
  <style>
    .script ul { font-family: monospace; }
    .script ul, li { list-style: none; margin: 0; padding: 0; line-height: 2em; }
    .script input { float: right; padding: calc(0.5em - 2px) 4px; width: calc(100% - 16em); }
    #gen { float: right; font-size: 120%; padding: 0.5em 2em; background: #ffa00a; color: #fff; text-decoration: none; border: 0 none; cursor: pointer; }
    #gen:hover { background: #ffb137; }
  </style>
  <script>
    var startDownload = function (data, filename) {
      var blob = new Blob([data], { type: 'application/octet-stream' });
      var url = window.URL.createObjectURL(blob);
      var saveas = document.createElement('a');
      saveas.href = url;
      saveas.style.display = 'none';
      document.body.appendChild(saveas);
      saveas.download = filename;
      saveas.click();
      setTimeout(function () { saveas.parentNode.removeChild(saveas); }, 1000)
      document.addEventListener('unload', function () { window.URL.revokeObjectURL(url); });
    };

    window.addEventListener('load', function () {
      var file = document.querySelector('input[type="file"]');
      var rules = null;
      var updateFile = function () {
        var reader = new FileReader();
        reader.addEventListener('load', function () {
          try {
            rules = JSON.parse(reader.result).conf;
            if (!rules) throw '';
          } catch (e) {
            alert('读取文件失败，请选择 YAWF 导出的配置文件');
            file.value = '';
          }
        });
        reader.readAsText(file.files[0]);
      };
      file.addEventListener('change', updateFile); updateFile();
      items.addEventListener('submit', function (e) {
        e.preventDefault();
        var config = {};
        var script = [];
        var inputs = document.querySelectorAll('input[type="text"]');
        Array.apply(Array, inputs).map(function (i) { if (i.value) config[i.name] = i.value; });
        var key = config.name.replace(/[^a-zA-Z0-9]/g, '_');
        script = script.concat([
          "// ==UserScript==",
          "// @include     http://www.weibo.com/*",
          "// @include     http://weibo.com/*",
          "// @exclude     http://weibo.com/a/bind/test",
        ]);
        ['name', 'namespace', 'description', 'version', 'copyright'].forEach(function (i) {
          if (config[i]) script = script.concat(["// @" + i + Array(13 - i.length).join(' ') + config[i]]);
        });
        script = script.concat([
          "// @grant       unsafeWindow",
          "// @grant       GM_addStyle",
          "// @run-at      document-start",
          "// ==/UserScript==",
          "",
          "// Generated by https://tiansh.github.io/yawf/subscribe_creator.html",
          "",
          "if (!unsafeWindow.$_YAWF_$) unsafeWindow.$_YAWF_$ = [];",
          "unsafeWindow.$_YAWF_$.push(['filter', {",
          "  'i18n': {",
        ]);
        ['zh-cn', 'zh-hk', 'zh-tw', 'en'].forEach(function (i) {
          if (config[i]) script = script.concat(["    '" + i + "': { 'name': '" + config[i] + "', },"]);
        });
        script = script.concat([
          "  },",
          "  'type': 'boolean',",
          "  'key': '" + key + "',",
          "  'text': '{{name}}',",
          "  'ainit': function () {",
        ]);
        ["keyword", "regexp", "account", "original", "mention", "topic", "rtopic", "source", "hyperlink"].forEach(function (name) {
          ["blacklist", "whitelist", "foldlist"].forEach(function (type) {
            var key = 'weibo.filters.' + name + '.' + type;
            if (rules[key] && rules[key].length)
              script = script.concat(["    unsafeWindow.$_YAWF_$.push(['extent', '" + name + "', '" + type + "', " + JSON.stringify(rules[key]) + "]);"]);
          });
        });
        script = script.concat([
          "  },",
          "}]);",
        ]);
        if (rules['weibo.tool.userstyle']) script = script.concat(["GM_addStyle('" + rules['weibo.tool.userstyle'].replace(/[\s\r\n]/g, ' ') + "');"]);
        startDownload(script.join('\n'), key + '.user.js');
      });
    });
  </script>
</head>
<body>
  <header><h1>YAWF 订阅创建器</h1></header>
  <h2>说明</h2>
  <div class="in">
    <p>该工具可以读取您的 YAWF 设置文件，提取其中内容、账号、话题、来源、链接的黑白灰名单，和自定义 CSS；创建一个供他人使用的脚本扩展。安装该扩展并启用即可按照您设定的关键词或帐号过滤微博了。</p>
  </div>
  <h2>创建订阅</h2>
  <div class="in script">
    <form id="items" method="GET">
      <ul>
        <li><span class="meta">@name</span><span class="input"><input type="text" required name="name" placeholder="名称（为了良好的兼容性，建议仅使用字母）" /></span></li>
        <li><span class="meta">@namespace</span><span class="input"><input type="text" required name="namespace" placeholder="名空间（您可以使用您的微博主页、个人主页、UUID等任何不会与他人重复的字串）" /></span></li>
        <li><span class="meta">@description</span><span class="input"><input type="text" required name="description" placeholder="对脚本的一句话简介（简介可以随意使用汉字）" /></span></li>
        <li><span class="meta">@version</span><span class="input"><input type="text" required name="version" placeholder="版本号" /></span></li>
        <li><span class="meta">@copyright</span><span class="input"><input type="text" name="copyright" placeholder="该订阅文件的版权信息（选填）" /></span></li>
        <li><span class="meta">设置文件</span><span class="input"><input required name="file" placeholder="YAWF 导出的设置文件" type="file" /></span></li>
        <li><span class="meta">设置项(zh-cn)</span><span class="input"><input type="text" required name="zh-cn" placeholder="显示在 YAWF 设置中的设置项文本 (zh-cn)" /></span></li>
        <li><span class="meta">设置项(zh-hk)</span><span class="input"><input type="text" name="zh-hk" placeholder="显示在 YAWF 设置中的设置项文本 (zh-hk)" /></span></li>
        <li><span class="meta">设置项(zh-tw)</span><span class="input"><input type="text" name="zh-tw" placeholder="显示在 YAWF 设置中的设置项文本 (zh-tw)" /></span></li>
        <li><span class="meta">设置项(en)</span><span class="input"><input type="text" name="en" placeholder="显示在 YAWF 设置中的设置项文本 (en)" /></span></li>
      </ul>
      <div><button id="gen" type="submit">生成配置文件</button></div>
    </form>
  </div>
  <h2>发布脚本</h2>
  <div class="in">
    <p>如果您希望和更多人共享您的设置，您可以将它们发布到网上供他人下载。如果可以仅修改内容而不修改 URL ，那么您修改的内容还可以通过自动更新的方式推送给他人，实现订阅的效果。下面以 Gist 为例介绍如何共享和安装。如果您熟悉用户脚本的共享方式，您可以忽略本段内容。</p>
    <h3>Gist</h3>
    <div class="in">
      <p><a target="_blank" href="https://gist.github.com/">https://gist.github.com/</a> 是一个代码共享的平台。</p>
      <p>打开上面的这个链接，将上面生成的文件用写字板或其他文本编辑器打开，将文件内容粘贴到网页的编辑框内；将文件名写入文本框左上方“Name this file...”位置，然后在上面的“Gist description...”中添加您对脚本的描述。最后点击下面的“Create Gist”即可将该脚本发布到 Gist 上。之后您可以将该脚本的 URL 共享给他人访问。</p>
      <p>如果您希望安装在 Gist 上发布的脚本，打开脚本的页面，在脚本的代码段右上可以看到一个写有“Raw”的按钮。点击该按钮并按照 Greasemonkey 的指引安装即可。安装后需要在 YAWF 的设置中启用对应设置项才能生效。</p>
    </div>
    <p>如果您有很好的订阅规则，您也可以直接联系我，我可以将它的链接放到脚本的主页上方便大家订阅。放到脚本主页的订阅要求满足：针对长期有效的内容而非一时的新闻热点；专注于某一方面而非宽泛的过滤项；描述与过滤的内容一致；漏报误报较少；绝大多数在过滤器内的帐号应当至少有 1000 个粉丝。</p>
  </div>
</body>
</html>